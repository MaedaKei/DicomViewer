# DicomViewer
## 概要
DICOM画像の表示・解析ができるビューワです。
リポジトリ内のzipファイルはアプリのビルドが完了しているものです。任意のディレクトリにて解凍すると使用可能となります。

## 機能一覧
### メイン機能
- **画像読み込み**:
  - 対応データ: CT, MASK, MASKDIFF, CONTOUR (RT Structure Set)
  - 読み込み方式: ディレクトリ指定、複数ファイル選択
  - **パス一括置換 (Change & Load)**: 読み込み済みデータのファイルパスを一括置換して再読み込み（症例切り替えなどに利用）
- **表示・レイアウト**:
  - グリッド表示（行・列数の任意変更）
  - キャンバスの配置入れ替え（CanvasMove）

### 解析・評価機能 (サブウィンドウ)
- **ROI管理 (ROISelect)**: ROIの選択、全選択/解除、選択状態の保存（メモリ機能）
- **評価指標 (Evaluate)**: Volumetric DSCの算出、計算結果の履歴保存
- **マスク操作 (MaskModifing)**: マスクカラーの変更、ラベル名の編集、凡例表示
- **画質調整 (CTWindowing)**: ヒストグラムを確認しながらのウィンドウレベル・幅の調整

## セットアップ(機能の追加を行う方向け)
### 前提条件
WindowsOS上での使用を想定しています。
リポジトリをクローンして各自の研究に必要な機能を追加してもらうことを想定しています。その場合、Windowsに以下がインストールされている必要があります。  
[Node.jsのインストールはこちらから](https://nodejs.org/ja)

動作を確認できたバージョン
  - node.js v22.18.0
  - npm 10.9.3

### インストール
1. リポジトリをクローン
Windowsのコマンドプロンプトを起動後、任意のディレクトリに移動した後、以下のコマンドでリポジトリをクローンします。URLはその都度ご確認ください。
クローンするとDicomViewer(クローン時点のこのレポジトリの名前)のディレクトリが作成されます。
```bash
git clone https://github.com/MaedaKei/DicomViewer
cd DicomViewer
```

2. 依存関係をインストール
リポジトリをクローンして作成されたディレクトリに移動後、以下のコマンドを実行します。
リポジトリ内のpackage-lock.jsonをもとに必要なパッケージをインストールします。
```bash
npm ci
```

3. 開発モードでの実行
アプリをビルドせずに、開発モードで素早く起動確認を行うことができます。
```bash
npm run start
```

4. アプリのビルド
electron-builderによりアプリのビルドを行っています。コード署名を回避するため出力はzip形式としています。
package.jsonのscriptセクションが編集されていない場合、以下のコマンドでアプリビルドが開始されます。
```bash
npm run build
```
ビルド時の条件はelectron-builder.ymlにて設定できますので、変更が必要な場合はお手数ですが記入例を検索の上編集をお願いします。

## 技術スタック
- **Runtime**: Electron v37.2.6
- **Language**: Vanilla JavaScript, HTML, CSS (No Framework)
- **DICOM Library**:
  - cornerstone-core v2.6.1
  - cornerstone-wado-image-loader v4.13.2
  - dicom-parser v1.8.21

## ディレクトリ構成
- `main.js`: アプリケーションのエントリーポイント（ウィンドウ管理、ライフサイクル）
- `MainWindow/`: メインビューワのロジック
  - `MainWindowRenderer.js`: 描画、データ管理、イベントハンドリングの中枢
- `SubWindows/`: 各機能の独立したウィンドウ
  - `ROISelect/`: ROI（関心領域）の選択・管理、メモリ機能
  - `Evaluate/`: 評価指標（Volumetric DSCなど）の計算、計算履歴の管理
  - `MaskModifing/`: マスクの色・ラベル名の変更、凡例表示
  - `CTWindowing/`: ヒストグラム表示、ウィンドウレベル/幅の調整

## 操作方法
### 画像の読み込み
画面上の読み込みパネルを使用します。
- **新規**: 新しいディレクトリからDICOM画像を読み込みます。
- **既存**: 既に読み込まれたデータを別のキャンバスに表示します。

### マウス操作
- **左クリック**: ボタン操作、範囲選択（AreaSelectモード時）
- **右クリック**: コンテキストメニューの表示（キャンバス上）
  - 各種サブウィンドウ（CTWindowing, ROISelectなど）へのアクセス
  - データの削除
- **中クリック (ホイールクリック)**: ズーム・パン位置のリセット
- **ホイール回転**:
  - 通常時: スライス送り
  - Zoomモード時: 拡大・縮小
  - CTWindowingサブウィンドウ: ウィンドウ幅（Radius）の調整

### コンテキストメニュー
右クリックで表示されるメニューは、表示中のデータタイプによって変化します。
- **CT**: CTWindowing（階調調整）
- **MASK**: MaskModifing（色・ラベル変更）、Evaluate（評価）
- **CONTOUR**: ROISelect（ROI選択）

## 使用可能なショートカット一覧

| キー | 対象 | 動作 | 詳細 |
| :--- | :--- | :--- | :--- |
| **Space** | Main | スライス同期 | 押下中、他の画像とスライス位置を同期します |
| **Space** | Main | SliceCrop範囲指定 | AreaSelectモード時、選択範囲の開始/終了スライスを指定します |
| **Enter** | 各種 | 値の確定 | ダイアログや数値入力欄での確定 |
| **M** | ROISelect | メモリ保存/読出 | 現在のROI選択状態を一時保存、または保存状態を復元します |
| **Ctrl + M** | ROISelect | メモリ上書き | 現在のROI選択状態でメモリを上書きします |
| **Ctrl** | ROISelect | モード切替 | 押下中、メモリ書き込みモードになります |

## トラブルシューティング

### よくある問題

## ライセンス

MIT License

## サポート
問題報告はissuesにて受付中(2025/11/15現在)です。
## メモ
2025/11/14時点：
CT画像、セグメンテーションマスク、セグメンテーションマスクの差分画像を表示可能。
評価指標はセグメンテーションマスク用のVolumetricDSCを搭載済み。
今後の開発予定：
1．セグメンテーションマスク用の評価指標HDの実装
2．輪郭データ対応
3．症例の一括変更機能
4．線量分布対応
